function setBusy(n){console.log("setBusy "+n);n?busyStack++==0&&(clearTimeout(busySpinnerOffTimer),busySpinnerOnTimer=setTimeout(function(){$(".busy-spinner").fadeIn()},250)):--busyStack==0&&(clearTimeout(busySpinnerOnTimer),busySpinnerOffTimer=setTimeout(function(){$(".busy-spinner").fadeOut()},250))}function requestDir(n){$.ajax({url:UrlUtils.makeUrl(n,""),cache:!1}).done(function(n){try{curDirObj=parseDirResponse(n);showDirList(curDirObj)}catch(t){console.log("Parse Response ERROR: "+t)}}).fail(function(n,t,i){console.log("Request ERROR: "+i);alert("The connection to the File Browser server has been lost.")})}function parseDirResponse(n){for(var r={dir:getDirectory(n),files:[],folders:[]},c=/<tr>(.*?)<\/tr>/gi,l=/<td.*?>(.*?)<\/td>/gi,e=[],u,f,i,t,o,h,s;(u=c.exec(n))!==null;)e.push(u[1]);for(f=0;f<e.length;++f){for(i=[];(u=l.exec(e[f]))!==null;)i.push(u[1]);i.length>=3&&(t={},t.url=i[0].substring(i[0].indexOf('"')+1,i[0].lastIndexOf('"')),t.name=i[0].substring(i[0].indexOf(">")+1,i[0].lastIndexOf("<")),t.name=decodeURIComponent(t.name.replace("&nbsp;","")),t.name.charAt(t.name.length-1)==="/"&&(t.name=t.name.substr(0,t.name.length-1)),t.size=i[1],t.size=decodeURIComponent(t.size.replace("&nbsp;","")),t.date=i[2],t.date=decodeURIComponent(t.date.replace("&nbsp;","")),(t.name.charAt(0)!=="."||showHidden)&&(t.url.charAt(t.url.length-1)==="/"?(o="/../",h=t.url.indexOf(o,t.url.length-o.length)!==-1,h||r.folders.push(t)):r.files.push(t)))}return s=function(n,t){return n.name.toLowerCase()<t.name.toLowerCase()?-1:n.name.toLowerCase()>t.name.toLowerCase()?1:0},r.files.sort(s),r.folders.sort(s),r}function getDirectory(n){var t=/<h1>(.*?)<\/h1>/i.exec(n);return t!==null?t[1].substr(t[1].indexOf("/"),t[1].length-1):"/"}function showDirList(n){var o=(displayRootDir+n.dir).split("/"),l=document.getElementById("current-dir"),s,f,h,c,r,e,i,t,u;for(l.innerHTML="",s="",r=0;r<o.length;++r)o[r]!==""&&(s+="/"+o[r],f=document.createElement("div"),f.className="dir-component",h=document.createElement("span"),h.appendChild(document.createTextNode(o[r])),f.appendChild(h),$(f).data("dir",s.replace(displayRootDir,"")),f.addEventListener("click",function(){var n=$(this).data("dir");requestDir(n)}),l.appendChild(f));if(browserElement.innerHTML="",n.files.length===0&&n.folders.length===0)i=document.createElement("tr"),i.className="browser-row",t=document.createElement("td"),t.className="browser-icon",u=document.createElement("i"),u.className="fa fa-exclamation-circle",t.appendChild(u),i.appendChild(t),t=document.createElement("td"),t.className="browser-name",t.appendChild(document.createTextNode("Folder is empty")),i.appendChild(t),t=document.createElement("td"),t.className="browser-size",i.appendChild(t),t=document.createElement("td"),t.className="browser-modified",i.appendChild(t),browserElement.appendChild(i);else{for(r=0;r<n.folders.length;++r)c=n.folders[r],i=document.createElement("tr"),i.className="browser-row drop-target",t=document.createElement("td"),t.className="browser-icon",u=document.createElement("i"),u.className="fa fa-folder",t.appendChild(u),i.appendChild(t),t=document.createElement("td"),t.className="browser-name",t.appendChild(document.createTextNode(c.name)),i.appendChild(t),t=document.createElement("td"),t.className="browser-size",t.appendChild(document.createTextNode("--")),i.appendChild(t),t=document.createElement("td"),t.className="browser-modified",t.appendChild(document.createTextNode("--")),i.appendChild(t),i.addEventListener("click",function(){var n=$(this).data("folder");requestDir(n.url)}),i.addEventListener("contextmenu",function(n){n.preventDefault();var t=$(this).data("folder");showContextMenu(n.pageX,n.pageY,t.url,t.name)}),browserElement.appendChild(i),$(i).data("folder",c);for(r=0;r<n.files.length;++r)e=n.files[r],i=document.createElement("tr"),i.className="browser-row",t=document.createElement("td"),t.className="browser-icon",u=document.createElement("i"),u.className="fa fa-file-o",t.appendChild(u),i.appendChild(t),t=document.createElement("td"),t.className="browser-name",t.appendChild(document.createTextNode(e.name)),i.appendChild(t),t=document.createElement("td"),t.className="browser-size",t.appendChild(document.createTextNode(e.size)),i.appendChild(t),t=document.createElement("td"),t.className="browser-modified",t.appendChild(document.createTextNode(e.date)),i.appendChild(t),i.addEventListener("click",function(){var n=$(this).data("file");openFile(n.url)}),i.addEventListener("contextmenu",function(n){n.preventDefault(n);var t=$(this).data("file");showContextMenu(n.pageX,n.pageY,t.url,t.name)}),browserElement.appendChild(i),$(i).data("file",e)}}function uploadFile(n,t,i,r){var u=new FormData,f=new Blob([i],{type:r});u.append(n,f,t);$.ajax({url:UrlUtils.makeUrl("upload"),data:u,cache:!1,contentType:!1,processData:!1,type:"POST"}).done(function(){requestDir(curDirObj.dir)}).fail(function(n,t,i){console.log(i);i.indexOf("EROFS")>-1&&alert("File upload failed, the folder is read only.")})}function openFile(n){console.log("openFile "+n);var t=window.open(n,"_blank");t.focus()}function showContextMenu(n,t,i,r){$(".context-menu").data("url",i);$(".context-menu").data("name",r);var u=n,f=t;$(".context-menu [data-action=Rename]").show();$(".context-menu [data-action=Delete]").show();u+$(".context-menu").width()>$(window).width()&&(u-=$(".context-menu").width());f+$(".context-menu").height()>$(window).height()&&(f-=$(".context-menu").height());$(".context-menu").css({top:f+"px",left:u+"px"});$(".context-menu").show()}function showBodyContextMenu(n,t){var i=n,r=t;$(".context-menu [data-action=Rename]").hide();$(".context-menu [data-action=Delete]").hide();i+$(".context-menu").width()>$(window).width()&&(i-=$(".context-menu").width());r+$(".context-menu").height()>$(window).height()&&(r-=$(".context-menu").height());$(".context-menu").css({top:r+"px",left:i+"px"});$(".context-menu").show()}function onRename(n,t){var u=prompt("Rename",t),i,r,f;u!==null&&u!==t&&u.trim()!==""&&(i="",n.charAt(n.length-1)==="/"?(r=n.lastIndexOf("/"),i=n.substr(0,r),r=i.lastIndexOf("/"),i=i.substr(0,r+1)+encodeURIComponent(u)+"/"):(r=n.lastIndexOf("/"),i=n.substr(0,r+1)+encodeURIComponent(u)),f={file:n,newname:i},$.ajax({url:UrlUtils.makeUrl("rename",f),cache:!1}).done(function(n){try{var t=JSON.parse(n);t.status==="OK"?requestDir(curDirObj.dir):alert(t.status)}catch(i){console.log("Parse Response ERROR: "+i)}}).fail(function(n,t,i){console.log("Request Error: "+i);alert("The connection to the File Browser server has been lost.")}))}function onDelete(n,t){var r=confirm("Confirm delete '"+t+"'?"),i;r&&(i={file:n},$.ajax({url:UrlUtils.makeUrl("delete",i),cache:!1}).done(function(n){try{var t=JSON.parse(n);t.status==="OK"?requestDir(curDirObj.dir):alert(t.status)}catch(i){console.log("Parse Response ERROR: "+i)}}).fail(function(n,t,i){console.log("Request Error: "+i);alert("The connection to the File Browser server has been lost.")}))}function onNewFolder(n){var t=n+prompt("New Folder"),i;t.trim()!==""&&(i={name:t},$.ajax({url:UrlUtils.makeUrl("mkdir",i),cache:!1}).done(function(n){try{var t=JSON.parse(n);t.status==="OK"?requestDir(curDirObj.dir):alert(t.status)}catch(i){console.log("Parse Response ERROR: "+i)}}).fail(function(n,t,i){console.log("Request Error: "+i);alert("The connection to the File Browser server has been lost.")}))}function handleAssetDragOver(n){n.stopPropagation&&n.stopPropagation();n.preventDefault&&n.preventDefault();n.dataTransfer.dropEffect="copy";var t=$(n.target).closest(".drop-target");t!==null&&t.addClass("highlight")}function handleAssetDragEnter(){}function handleAssetDragLeave(n){var t=$(n.target).closest(".drop-target");t!==null&&t.removeClass("highlight")}function handleAssetDragEnd(n){dragOverStack=[];var t=$(n.target).closest(".drop-target");t!==null&&t.removeClass("highlight")}function handleAssetDrop(n){var i,f,r,t,u;for(n.stopPropagation&&n.stopPropagation(),n.preventDefault&&n.preventDefault(),dragOverStack=[],i=$(n.target).closest(".drop-target"),i!==null&&i.removeClass("highlight"),f=typeof i.data("folder")!="undefined"?i.data("folder").url:curDirObj.dir,r=n.dataTransfer.files,t=0;t<r.length;++t)u=new FileReader,u.source=r[t],u.onload=function(n){var t=n.target.source,i=n.target.result;uploadFile(f,t.name,i,t.type)},u.onerror=function(){console.log("FileReader failed to read "+r[t])},u.readAsArrayBuffer(r[t])}var curDirObj=null,browserElement=null,displayRootDir="/sdcard",showHidden=!0,busyStack=0,busySpinnerOnTimer=null,busySpinnerOffTimer=null,UrlUtils={makeUrl:function(n,t){var i="http://"+location.host,r,u;if(i+=n.charAt(0)=="/"?n:"/"+n,typeof t!="undefined"){r="?";for(u in t)i+=r+u+"="+t[u],r="&"}return i}};window.addEventListener("load",function(){console.log("onload");$(document).ajaxStart(function(){setBusy(!0)});$(document).ajaxStop(function(){setBusy(!1)});browserElement=document.getElementsByClassName("browser")[0];var n=document.getElementsByClassName("drop-target")[0];n.addEventListener("dragover",handleAssetDragOver);n.addEventListener("drop",handleAssetDrop);n.addEventListener("dragenter",handleAssetDragEnter);n.addEventListener("dragleave",handleAssetDragLeave);n.addEventListener("dragend",handleAssetDragEnd);$(document).bind("contextmenu",function(n){n.target===document.body&&showBodyContextMenu(n.pageX,n.pageY);n.preventDefault()});$(document).bind("mousedown",function(n){$(".context-menu").is(":visible")&&!$(n.target).parents(".context-menu").length>0&&$(".context-menu").hide()});requestDir("/")});$(document).on("click",".context-menu li",function(){var n=$(this).parent(".context-menu");switch($(this).attr("data-action")){case"Rename":onRename(n.data("url"),n.data("name"));break;case"Delete":onDelete(n.data("url"),n.data("name"));break;case"New Folder":onNewFolder(curDirObj.dir)}$(".context-menu").hide()})